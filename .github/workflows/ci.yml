name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  RUST_VERSION: "1.75"

jobs:
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run linting
        run: |
          source .venv/bin/activate
          uv run ruff check .

      - name: Run Python tests - example_simple
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_simple/test_trivial_cli.py -v --cov=examples/example_simple/trivial_cli.py

      - name: Run Python tests - example_flags
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_flags/test_flag_parser.py -v --cov=examples/example_flags/flag_parser.py

      - name: Run Python tests - example_positional
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_positional/test_positional_args.py -v --cov=examples/example_positional/positional_args.py

      - name: Run Python tests - example_subcommands
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_subcommands/test_git_clone.py -v --cov=examples/example_subcommands/git_clone.py

      - name: Run Python tests - example_complex
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_complex/test_complex_cli.py -v --cov=examples/example_complex/complex_cli.py

      - name: Run Python tests - example_stdlib
        run: |
          source .venv/bin/activate
          uv run pytest examples/example_stdlib/test_stdlib_integration.py -v --cov=examples/example_stdlib/stdlib_integration.py

      - name: Test summary
        run: |
          echo "‚úÖ All Python tests passed!"
          echo "üìä Total: 192 tests across 6 examples"

  rust-tests:
    name: Rust Integration Tests
    runs-on: ubuntu-latest
    needs: python-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Rust binaries exist
        id: check_binaries
        run: |
          echo "Checking for pre-compiled Rust binaries..."
          MISSING=0
          for example in trivial_cli flag_parser positional_args git_clone complex_cli stdlib_integration; do
            if [ ! -f "examples/example_*/$example" ]; then
              echo "‚ö†Ô∏è  Binary not found: $example"
              MISSING=1
            fi
          done
          echo "missing=$MISSING" >> $GITHUB_OUTPUT

      - name: Note about missing binaries
        if: steps.check_binaries.outputs.missing == '1'
        run: |
          echo "‚ÑπÔ∏è  Rust binaries not found. This is expected."
          echo "   Rust I/O equivalence tests require depyler to compile Python to Rust."
          echo "   These tests will be skipped in CI until binaries are committed or compiled."
          echo ""
          echo "   To run locally:"
          echo "   1. Install depyler"
          echo "   2. Run 'make compile' in each example directory"
          echo "   3. Run 'cargo test --test test_io_equivalence'"

      - name: Run Rust integration tests (if binaries exist)
        if: steps.check_binaries.outputs.missing == '0'
        run: |
          cargo test --test test_io_equivalence --verbose

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Check Python formatting
        run: |
          source .venv/bin/activate
          uv run ruff format --check .

      - name: Type checking (if mypy configured)
        continue-on-error: true
        run: |
          source .venv/bin/activate
          if uv pip list | grep -q mypy; then
            uv run mypy examples/
          else
            echo "‚ÑπÔ∏è  mypy not configured, skipping"
          fi

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" examples/ --include="*.py" | grep -v "test_" | head -n 10; then
            echo "‚ö†Ô∏è  Found TODO/FIXME comments (informational)"
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          test -f README.md && echo "‚úÖ README.md exists"
          test -f STATUS.md && echo "‚úÖ STATUS.md exists"
          test -f roadmap.yaml && echo "‚úÖ roadmap.yaml exists"

      - name: Check example READMEs
        run: |
          for example in examples/example_*/; do
            if [ -f "$example/README.md" ]; then
              echo "‚úÖ $example has README.md"
            else
              echo "‚ùå $example missing README.md"
              exit 1
            fi
          done

      - name: Check documentation structure
        run: |
          test -d docs/ && echo "‚úÖ docs/ directory exists"
          test -f docs/specifications/argparse-depyler-compile-examples-spec.md && echo "‚úÖ Specification exists"
          test -f docs/rust-io-tests.md && echo "‚úÖ Rust tests documentation exists"

  status-check:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [python-tests, rust-tests, code-quality, documentation]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "Python Tests: ${{ needs.python-tests.result }}"
          echo "Rust Tests: ${{ needs.rust-tests.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"

          if [ "${{ needs.python-tests.result }}" != "success" ]; then
            echo "‚ùå Python tests failed"
            exit 1
          fi

          if [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "‚ùå Code quality checks failed"
            exit 1
          fi

          if [ "${{ needs.documentation.result }}" != "success" ]; then
            echo "‚ùå Documentation checks failed"
            exit 1
          fi

          echo "‚úÖ All CI checks passed!"
