name: Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  pmat-quality-gates:
    name: PMAT Quality Gates
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail CI if pmat not available

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if pmat is available
        id: check_pmat
        run: |
          if command -v pmat &> /dev/null; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ pmat is installed"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  pmat not installed, skipping quality gates"
          fi

      - name: Run pmat analyze
        if: steps.check_pmat.outputs.available == 'true'
        run: |
          pmat analyze tdg --format json > tdg-report.json
          echo "üìä TDG Analysis complete"

      - name: Run pmat quality gates
        if: steps.check_pmat.outputs.available == 'true'
        run: |
          pmat quality-gate --strict || echo "‚ö†Ô∏è  Quality gate warnings (not blocking)"

      - name: Upload TDG report
        if: steps.check_pmat.outputs.available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tdg-report
          path: tdg-report.json

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          source .venv/bin/activate

          echo "Running all tests with coverage..."
          uv run pytest examples/ -v --cov=examples/ --cov-report=xml --cov-report=term

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

      - name: Coverage summary
        run: |
          echo "üìä Coverage Summary"
          echo "==================="
          echo "Target: 100% coverage across all examples"
          echo "Tests: 192 Python tests + 38 Rust integration tests"

  complexity-analysis:
    name: Complexity Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install radon (complexity tool)
        run: |
          pip install radon

      - name: Analyze cyclomatic complexity
        run: |
          echo "üìä Cyclomatic Complexity Analysis"
          echo "=================================="
          radon cc examples/ -a -nb || echo "‚ÑπÔ∏è  Complexity analysis complete"

      - name: Analyze maintainability index
        run: |
          echo ""
          echo "üìä Maintainability Index"
          echo "========================"
          radon mi examples/ -nb || echo "‚ÑπÔ∏è  Maintainability analysis complete"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install safety
        run: |
          pip install safety

      - name: Check for known vulnerabilities
        continue-on-error: true
        run: |
          safety check --json || echo "‚ö†Ô∏è  Security scan complete (informational)"

      - name: Check for secrets in code
        run: |
          echo "üîç Checking for potential secrets..."
          if grep -r "api_key\|password\|secret\|token" examples/ --include="*.py" | grep -v "test_" | grep -v "# "; then
            echo "‚ö†Ô∏è  Found potential secrets (review manually)"
          else
            echo "‚úÖ No obvious secrets found"
          fi

  dependency-check:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check Python dependencies
        run: |
          pip install pip-audit
          pip-audit --requirement pyproject.toml || echo "‚ÑπÔ∏è  Dependency audit complete"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust dependency audit
        run: |
          cargo install cargo-audit || true
          if command -v cargo-audit &> /dev/null; then
            cargo audit || echo "‚ÑπÔ∏è  Rust dependency audit complete"
          else
            echo "‚ÑπÔ∏è  cargo-audit not available"
          fi

  performance-lint:
    name: Performance Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for performance anti-patterns
        run: |
          echo "üîç Checking for performance anti-patterns..."

          # Check for inefficient string concatenation
          if grep -r ".*+=.*" examples/ --include="*.py" | grep -v "test_" | head -n 5; then
            echo "‚ÑπÔ∏è  Found string concatenation (consider str.join())"
          fi

          # Check for excessive list comprehensions
          echo "‚úÖ Performance lint complete"

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [pmat-quality-gates, test-coverage, complexity-analysis, security-scan, dependency-check, performance-lint]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "üìä Quality Gates Summary"
          echo "========================"
          echo ""
          echo "PMAT Quality: ${{ needs.pmat-quality-gates.result }}"
          echo "Test Coverage: ${{ needs.test-coverage.result }}"
          echo "Complexity: ${{ needs.complexity-analysis.result }}"
          echo "Security: ${{ needs.security-scan.result }}"
          echo "Dependencies: ${{ needs.dependency-check.result }}"
          echo "Performance: ${{ needs.performance-lint.result }}"
          echo ""
          echo "‚ÑπÔ∏è  Quality gates are informational and do not block merges"
          echo "‚úÖ Use these reports to maintain code quality"
